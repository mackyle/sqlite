# 2023-12-18
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#***********************************************************************
# Invariant tests for JSON built around the randomjson extension
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix json106

load_static_extension db randomjson
db eval {
  CREATE TEMP TABLE t1(j0,j5);
}
unset -nocomplain ii
for {set ii 1} {$ii<=5000} {incr ii} {
  do_execsql_test $ii.1 {
    DELETE FROM t1;
    INSERT INTO t1(j0,j5) VALUES(random_json($ii),random_json5($ii));
    SELECT json_valid(j0), json_valid(j5,2) FROM t1;
  } {1 1}
  do_execsql_test $ii.2 {
    SELECT count(*)
      FROM t1, json_tree(j0) AS rt
     WHERE rt.type NOT IN ('object','array')
       AND rt.atom IS NOT (j0 ->> rt.fullkey);
  } 0
  do_execsql_test $ii.3 {
    SELECT count(*)
      FROM t1, json_tree(j5) AS rt
     WHERE rt.type NOT IN ('object','array')
       AND rt.atom IS NOT (j0 ->> rt.fullkey);
  } 0
}


finish_test
