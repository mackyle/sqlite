# 2024-11-16
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#***********************************************************************
#
# Test cases for COMMIT AND CONTINUE TRANSACTION.
#
set testdir [file dirname $argv0]
source $testdir/tester.tcl
unset -nocomplain ecode

db close
sqlite3 db test.db
sqlite3 db2 test.db
do_execsql_test -db db2 trans4-1.1 {
  CREATE TABLE t1(x);
  BEGIN;
  INSERT INTO t1 VALUES(1),(2),(3);
  SELECT * FROM t1;
} {1 2 3}

do_catchsql_test trans4-1.2 {
  SELECT * FROM t1;
} {0 {}}

do_execsql_test -db db2 trans4-1.3 {
  COMMIT AND CONTINUE TRANSACTION;
}

do_catchsql_test trans4-1.4 {
  SELECT * FROM t1;
} {1 {database is locked}}

do_execsql_test -db db2 trans4-1.5 {
  INSERT INTO t1 VALUES(4);
  INSERT INTO t1 VALUES(5);
  COMMIT;
}

do_catchsql_test trans4-1.6 {
  SELECT * FROM t1;
} {0 {1 2 3 4 5}}

db2 close
db eval {PRAGMA journal_mode=WAL; VACUUM;}
sqlite3 db2 test.db

do_execsql_test -db db2 trans4-2.1 {
  DELETE FROM t1;
  BEGIN;
  INSERT INTO t1 VALUES(1),(2),(3);
  SELECT * FROM t1;
} {1 2 3}

do_catchsql_test trans4-2.2 {
  SELECT * FROM t1;
} {0 {}}

do_execsql_test -db db2 trans4-2.3 {
  COMMIT AND CONTINUE TRANSACTION;
  INSERT INTO t1 VALUES(4);
}

do_catchsql_test trans4-2.4 {
  SELECT * FROM t1;
} {0 {1 2 3}}

do_execsql_test -db db2 trans4-2.5 {
  INSERT INTO t1 VALUES(5);
  COMMIT;
}

do_catchsql_test trans4-2.6 {
  SELECT * FROM t1;
} {0 {1 2 3 4 5}}

do_catchsql_test trans4-3.1 {
  BEGIN;
  COMMIT AND continuex TRANSACTION;
} {1 {near "continuex": syntax error}}
do_catchsql_test trans4-3.2 {
  COMMIT AND continue;
} {1 {near ";": syntax error}}
do_catchsql_test trans4-3.3 {
  COMMIT AND continue Transaction;
} {0 {}}
db2 close

finish_test
